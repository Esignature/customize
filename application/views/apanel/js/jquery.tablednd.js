jQuery.tableDnD={currentTable:null,dragObject:null,mouseOffset:null,oldY:0,build:function(a){this.each(function(){this.tableDnDConfig=jQuery.extend({onDragStyle:null,onDropStyle:null,onDragClass:"tDnD_whileDrag",onDrop:null,onDragStart:null,scrollAmount:5,serializeRegexp:/[^\-]*$/,serializeParamName:null,dragHandle:null},a||{});jQuery.tableDnD.makeDraggable(this)});jQuery(document).bind("mousemove",jQuery.tableDnD.mousemove).bind("mouseup",jQuery.tableDnD.mouseup);return this},makeDraggable:function(b){var c=b.tableDnDConfig;if(b.tableDnDConfig.dragHandle){var d=jQuery("td."+b.tableDnDConfig.dragHandle,b);d.each(function(){jQuery(this).mousedown(function(e){jQuery.tableDnD.dragObject=this.parentNode;jQuery.tableDnD.currentTable=b;jQuery.tableDnD.mouseOffset=jQuery.tableDnD.getMouseOffset(this,e);if(c.onDragStart){c.onDragStart(b,this)}return false}).css("cursor","move")})}else{var a=jQuery("tr",b);a.each(function(){var e=jQuery(this);if(!e.hasClass("nodrag")){e.mousedown(function(f){if(f.target.tagName=="TD"){jQuery.tableDnD.dragObject=this;jQuery.tableDnD.currentTable=b;jQuery.tableDnD.mouseOffset=jQuery.tableDnD.getMouseOffset(this,f);if(c.onDragStart){c.onDragStart(b,this)}return false}}).css("cursor","move")}})}},updateTables:function(){this.each(function(){if(this.tableDnDConfig){jQuery.tableDnD.makeDraggable(this)}})},mouseCoords:function(a){if(a.pageX||a.pageY){return{x:a.pageX,y:a.pageY}}return{x:a.clientX+document.body.scrollLeft-document.body.clientLeft,y:a.clientY+document.body.scrollTop-document.body.clientTop}},getMouseOffset:function(b,a){a=a||window.event;var d=this.getPosition(b);var c=this.mouseCoords(a);return{x:c.x-d.x,y:c.y-d.y}},getPosition:function(c){var b=0;var a=0;if(c.offsetHeight==0){c=c.firstChild}while(c.offsetParent){b+=c.offsetLeft;a+=c.offsetTop;c=c.offsetParent}b+=c.offsetLeft;a+=c.offsetTop;return{x:b,y:a}},mousemove:function(b){if(jQuery.tableDnD.dragObject==null){return}var c=jQuery(jQuery.tableDnD.dragObject);var g=jQuery.tableDnD.currentTable.tableDnDConfig;var h=jQuery.tableDnD.mouseCoords(b);var a=h.y-jQuery.tableDnD.mouseOffset.y;var f=window.pageYOffset;if(document.all){if(typeof document.compatMode!="undefined"&&document.compatMode!="BackCompat"){f=document.documentElement.scrollTop}else{if(typeof document.body!="undefined"){f=document.body.scrollTop}}}if(h.y-f<g.scrollAmount){window.scrollBy(0,-g.scrollAmount)}else{var e=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:document.body.clientHeight;if(e-(h.y-f)<g.scrollAmount){window.scrollBy(0,g.scrollAmount)}}if(a!=jQuery.tableDnD.oldY){var i=a>jQuery.tableDnD.oldY;jQuery.tableDnD.oldY=a;if(g.onDragClass){c.addClass(g.onDragClass)}else{c.css(g.onDragStyle)}var d=jQuery.tableDnD.findDropTargetRow(c,a);if(d){if(i&&jQuery.tableDnD.dragObject!=d){jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,d.nextSibling)}else{if(!i&&jQuery.tableDnD.dragObject!=d){jQuery.tableDnD.dragObject.parentNode.insertBefore(jQuery.tableDnD.dragObject,d)}}}}return false},findDropTargetRow:function(j,c){var b=jQuery.tableDnD.currentTable.rows;for(var a=0;a<b.length;a++){var f=b[a];var d=this.getPosition(f).y;var e=parseInt(f.offsetHeight)/2;if(f.offsetHeight==0){d=this.getPosition(f.firstChild).y;e=parseInt(f.firstChild.offsetHeight)/2}if((c>d-e)&&(c<(d+e))){if(f==j){return null}var g=jQuery.tableDnD.currentTable.tableDnDConfig;if(g.onAllowDrop){if(g.onAllowDrop(j,f)){return f}else{return null}}else{var h=jQuery(f).hasClass("nodrop");if(!h){return f}else{return null}}return f}}return null},mouseup:function(c){if(jQuery.tableDnD.currentTable&&jQuery.tableDnD.dragObject){var a=jQuery.tableDnD.dragObject;var b=jQuery.tableDnD.currentTable.tableDnDConfig;if(b.onDragClass){jQuery(a).removeClass(b.onDragClass)}else{jQuery(a).css(b.onDropStyle)}jQuery.tableDnD.dragObject=null;if(b.onDrop){b.onDrop(jQuery.tableDnD.currentTable,a)}jQuery.tableDnD.currentTable=null}},serialize:function(){if(jQuery.tableDnD.currentTable){return jQuery.tableDnD.serializeTable(jQuery.tableDnD.currentTable)}else{return"Error: No Table id set, you need to set an id on your table and every row"}},serializeTable:function(c){var b="";var a=c.id;var f=c.rows;for(var d=0;d<f.length;d++){if(b.length>0){b+="&"}var e=f[d].id;if(e&&e&&c.tableDnDConfig&&c.tableDnDConfig.serializeRegexp){e=e.match(c.tableDnDConfig.serializeRegexp)[0]}b+=a+"[]="+e}return b},serializeTables:function(){var a="";this.each(function(){a+=jQuery.tableDnD.serializeTable(this)});return a}};jQuery.fn.extend({tableDnD:jQuery.tableDnD.build,tableDnDUpdate:jQuery.tableDnD.updateTables,tableDnDSerialize:jQuery.tableDnD.serializeTables});